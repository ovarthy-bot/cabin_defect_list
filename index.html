<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>U√ßak Defect Takip (Firebase)</title>
    <style>

        let suppressSuggestions = false;


/* --- EV (HOME) BUTONU STƒ∞Lƒ∞ - G√úNCELLENDƒ∞ --- */
/* --- MEN√ú BUTONU STƒ∞Lƒ∞ - G√úNCELLENDƒ∞ --- */
.menu-btn { 
    position: fixed; 
    top: 25px; 
    left: 15px; 
    font-size: 24px; 
    cursor: pointer; 
    background-color: #007bff; 
    color: white; 
    width: 45px;
    height: 45px; 
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%; 
    z-index: 2001; /* EV butonundan daha √ºstte */
    box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    border: 2px solid white;
    transition: transform 0.2s;
}

.menu-btn:active { transform: scale(0.9); }

/* --- EV (HOME) BUTONU STƒ∞Lƒ∞ - G√úNCELLENDƒ∞ --- */
.home-btn { 
    position: fixed; 
    top: 60px; /* Men√º butonunun hemen altƒ± (25px + 45px + 10px bo≈üluk) */
    left: 15px; /* Men√º butonuyla aynƒ± hizada */
    font-size: 24px; 
    cursor: pointer; 
    background-color: #17a2b8; 
    color: white; 
    width: 45px; 
    height: 45px; 
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%; 
    z-index: 2000; /* Men√º butonundan daha altta */
    text-decoration: none; 
    box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    border: 2px solid white;
    transition: all 0.3s ease;
}

.home-btn:hover { 
    background-color: #138496; 
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}

.home-btn:active { 
    transform: scale(0.95);
}

/* Mobil cihazlar i√ßin optimize edilmi≈ü buton yerle≈üimi */
@media (max-width: 600px) {
    .menu-btn {
        top: 5px;
        left: 10px;
        width: 30px;
        height: 30px;
        font-size: 20px;
    }
    
    .home-btn {
        top: 5px;      /* Men√º butonuyla aynƒ± hizaya (yukarƒ±) √ßektik */
        left: 50px;     /* Men√º butonunun geni≈üliƒüi + bo≈üluk (10+45+10) */
        width: 30px;
        height: 30px;
        font-size: 20px;
    }

    /* √ústten butonlarƒ±n √ºst√ºne binmemesi i√ßin konteynere biraz pay verelim */
    .container { 
        margin-top: 75px; 
        padding: 10px; 
    }
    
    .container.sidebar-open { 
        margin-left: 0; 
        transform: translateX(250px); 
    }
}
        
        /* --- GENEL STƒ∞LLER (AYNEN KORUNDU VE G√úNCELLENDƒ∞) --- */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; display: flex; overflow-x: hidden; transition: background-color 0.3s, color 0.3s; }
        .sidebar { 
    height: 100%; 
    width: 0; 
    position: fixed; 
    top: 0; 
    left: 0; 
    background-color: #333; 
    overflow-x: hidden; 
    transition: 0.3s; 
    padding-top: 130px; /* 60px'den 100px'e √ßƒ±karƒ±ldƒ± (ƒ∞stediƒüiniz kadar artƒ±rabilirsiniz) */
    color: white; 
    z-index: 1001; 
}
        .sidebar.open { width: 250px; }
        /* --- KAPATMA BUTONU KONUMU G√úNCELLENDƒ∞ --- */
.sidebar .close-btn { 
    position: absolute; 
    top: 40px; /* 10px'den 40px'e √ßekildi */
    right: 25px; 
    font-size: 36px; 
    cursor: pointer; 
}
        .sidebar-content { padding: 20px; }
        .sidebar-content label { display: block; margin-bottom: 10px; font-weight: bold; }
        .sidebar-content input, .sidebar-content select, .sidebar-content button { width: 100%; padding: 8px; margin-bottom: 20px; border: none; border-radius: 4px; cursor: pointer; }
        .sidebar-content button { background-color: #4CAF50; color: white; }
        .sidebar-content button:hover { background-color: #45a049; }
        .menu-btn { 
    position: fixed; 
    top: 5px; /* √ústten biraz daha a≈üaƒüƒ± √ßekerek durum √ßubuƒüundan kurtardƒ±k */
    left: 15px; 
    font-size: 24px; 
    cursor: pointer; 
    background-color: #007bff; 
    color: white; 
    width: 30px; /* Kare yerine dairesel ve daha b√ºy√ºk */
    height: 30px; 
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%; 
    z-index: 2000; 
    box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    border: 2px solid white; /* G√∂r√ºn√ºrl√ºƒü√º artƒ±rmak i√ßin √ßer√ßeve */
}
        
        .container { max-width: 800px; margin: 20px auto; padding: 20px; background-color: #fff; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); border-radius: 8px; transition: margin-left 0.3s, background-color 0.3s, color 0.3s; text-align: center; }
        .container.sidebar-open { margin-left: 250px; }
        .email-info { position: absolute; top: 10px; right: 10px; font-size: 12px; color: #555; }
        
        /* U√ßak Y√∂netimi Stilleri */
        .airplane-management { display: flex; gap: 5px; margin-bottom: 15px; align-items: flex-end;}
        .airplane-management select { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .airplane-btn { padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; min-width: 40px;}
        .airplane-btn.delete { background-color: #dc3545; }
        
        .input-section label { display: block; margin-top: 10px; font-weight: bold; text-align: left;}
        .input-section input, .input-section select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
        .input-section button.main-save-btn { display: block; width: 100%; padding: 10px; margin-top: 20px; background-color: #007bff; color: #fff; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
        .input-section button.main-save-btn:hover { background-color: #000000; }
        
        .list-section { margin-top: 20px; }
        #defect-list { list-style-type: none; padding: 0; }
        #defect-list li { margin-bottom: 15px; padding: 15px; background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; display: flex; flex-direction: row; align-items: flex-start; justify-content: space-between; position: relative;}
        #defect-list img { width: 100px; height: 100px; margin-right: 15px; border-radius: 4px; object-fit: cover; cursor: pointer; }
        #defect-list .defect-details { flex-grow: 1; text-align: left; }
        #defect-list .defect-details div { margin: 5px 0; font-size: 14px; }
        #defect-list .defect-details .label { font-weight: bold; color: #333; }
        
        .buttons { display: flex; gap: 10px; align-self: flex-end; }
        .shortcut-buttons { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .shortcut-buttons button { padding: 5px 10px; border: none; background-color: #333; color: white; border-radius: 3px; cursor: pointer; font-size: 12px; }
        
        .export-button, .import-button { width: 100%; padding: 10px; margin-top: 10px; color: #fff; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
        .export-button { background-color: #28a745; }
        .import-button { background-color: #bbcd1a; }
        
        .image-upload-options { display: flex; gap: 10px; margin-top: 5px; justify-content: center; }
        .image-upload-options button { width: 40px; height: 40px; border-radius: 4px; background-color: #6c757d; border: none; color: white; cursor: pointer; position: relative; font-size: 20px; }
        
        .suggestion-list { position: absolute; background-color: #fff; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; width: 90%; z-index: 1000; display: none; text-align: left; }
        .suggestion-list div { padding: 8px; cursor: pointer; }
        .suggestion-list div:hover { background-color: #f0f0f0; }

        /* Loader */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: none; margin: 0 auto;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Dark Theme overrides */
        body.dark-theme { background-color: #1a1a1a; color: #fff; }
        .dark-theme .container { background-color: #2d2d2d; color: #fff; }
        .dark-theme .input-section input, .dark-theme .input-section select { background-color: #3a3a3a; color: #fff; border-color: #555; }
        .dark-theme #defect-list li { background-color: #3a3a3a; border-color: #555; }
        .dark-theme .defect-details .label { color: #ccc; }
        
        @media (max-width: 600px) {
            .container { margin-left: 0; padding: 10px; }
            .container.sidebar-open { margin-left: 0; transform: translateX(250px); }
            #defect-list li { flex-direction: column; }
            #defect-list .buttons { width: 100%; justify-content: space-between; margin-top: 10px; }
            .airplane-management { flex-wrap: wrap; }
            .airplane-management select { width: 100%; }
        }
    </style>
</head>

<body>
    <div class="menu-btn" onclick="toggleSidebar()">‚ò∞</div>
    <a href="https://ovarthy-bot.github.io/navigasyon/" class="home-btn" title="Cabin Defect List">üè†</a>
    <div class="sidebar" id="sidebar">
        <span class="close-btn" onclick="toggleSidebar()">√ó</span>
        <div class="sidebar-content">
            <label for="image-scale">Resim Kalitesi (0.1 - 1):</label>
            <input type="number" id="image-scale" step="0.1" min="0.1" max="1" value="1">
            <label for="theme-select">Tema:</label>
            <select id="theme-select" onchange="changeTheme()">
                <option value="light" selected>A√ßƒ±k Tema</option>
                <option value="dark">Karanlƒ±k Tema</option>
            </select>
            <button onclick="alert('Bu √∂zellik ≈üu an bakƒ±mda.')">Koltuk No Sƒ±rala</button>
            <div style="margin-top: 20px; font-size: 12px; color: #aaa;">Firebase Connected</div>
        </div>
    </div>

    <div class="email-info">ovar@thy.com</div>

    <div class="container" id="main-container">
        <div class="input-section">
            <label for="airplane-select">U√áAK SE√áƒ∞Mƒ∞ (Fƒ∞LTRE):</label>
            <div class="airplane-management">
                <select id="airplane-select" onchange="filterByAirplane()">
                    <option value="" disabled selected>U√ßak Se√ßiniz veya Ekleyiniz</option>
                    </select>
                <button class="airplane-btn" onclick="addNewAirplane()" title="Yeni U√ßak Ekle">+</button>
                <button class="airplane-btn delete" onclick="deleteSelectedAirplane()" title="Se√ßili U√ßaƒüƒ± Sil">-</button>
            </div>

            <label for="defect">DEFECT:</label>
            <div class="shortcut-buttons">
                <button type="button" onclick="addShortcut('MISSING')">MISSING üîç</button>
                <button type="button" onclick="addShortcut('DAMAGED')">DAMAGED üì¶</button>
                <button type="button" onclick="addShortcut('DISLOCATED')">DISLOCATED ‚ÜîÔ∏è</button>
                <button type="button" onclick="addShortcut('LOOSE')">LOOSE üî©</button>
                <button type="button" onclick="addShortcut('NOT WORKING')">NOT WORKING ‚ùå</button>
            </div>
            <input type="text" id="defect" placeholder="Defect giriniz" autocomplete="off"
                oninput="this.value = this.value.toUpperCase(); showSuggestions(this.value)">
            <div id="suggestion-list" class="suggestion-list"></div>

            <label for="location">LOCATION:</label>
            <input type="text" id="location" placeholder="Location giriniz" oninput="handleUpperCase(this)">

            <label for="note">NOTE:</label>
            <input type="text" id="note" placeholder="Note giriniz" oninput="handleUpperCase(this)">

            <label for="partNumber">P/N:</label>
            <input type="text" id="partNumber" placeholder="Part Number giriniz" oninput="handleUpperCase(this)">

            <label for="manHours">M/H:</label>
            <input type="text" id="manHours" placeholder="Man Hours giriniz" oninput="handleUpperCase(this)">

            <label>Resim Y√ºkle:</label>
            <div class="image-upload-options">
                <button onclick="document.getElementById('camera-upload').click()">üì∑</button>
                <button onclick="document.getElementById('gallery-upload').click()">üñºÔ∏è</button>
            </div>
            <input type="file" id="camera-upload" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(event)">
            <input type="file" id="gallery-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
            
            <div id="image-preview-container" style="display:none; margin-top:10px;">
                <img id="preview-img" style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px;">
                <button onclick="clearImageSelection()" style="background:red; color:white; border:none; border-radius:50%; width:20px; height:20px; cursor:pointer;">x</button>
            </div>

            <button onclick="saveDefectToFirebase()" class="main-save-btn">
                <span id="save-text">Kaydet</span>
                <div id="save-loader" class="loader"></div>
            </button>

            <label for="search">Arama (Mevcut Liste ƒ∞√ßinde):</label>
            <input type="text" id="search" placeholder="Arama yapƒ±n" oninput="searchLocalList()">
        </div>

        <div class="list-section">
            <h2 id="list-header">Kaydedilen Defectler</h2>
            <ul id="defect-list"></ul>
        </div>

        <div style="margin-top: 20px; padding: 10px; background: #eee; border-radius: 4px;">
    <label for="export-scale" style="font-weight: bold; color: #333;">Excel Resim Kalitesi:</label>
    <select id="export-scale" style="padding: 5px; margin-left: 10px;">
        <option value="1">Y√ºksek (Orijinal)</option>
        <option value="0.5" selected>Orta (%50 K√º√ß√ºlt)</option>
        <option value="0.2">D√º≈ü√ºk (Hƒ±zlƒ±/K√º√ß√ºk Dosya)</option>
        <option value="0.05">√áok D√º≈ü√ºk (Sadece √ñnizleme)</option>
    </select>
</div>

        <button class="export-button" onclick="exportToExcel()">Listeyi Excele Aktar</button>
        </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, where, deleteDoc, doc, updateDoc, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // --- BURAYI DOLDURUN: KENDƒ∞ FIREBASE PROJE Bƒ∞LGƒ∞LERƒ∞Nƒ∞Z ---
        // Your web app's Firebase configuration
        const firebaseConfig = {
        apiKey: "AIzaSyAXKtBrHzw5P6vO0MwzrD-TJdm7t6heLpg",
        authDomain: "cabin-defect-list-5594c.firebaseapp.com",
        projectId: "cabin-defect-list-5594c",
        storageBucket: "cabin-defect-list-5594c.firebasestorage.app",
        messagingSenderId: "1074016655708",
        appId: "1:1074016655708:web:dd74b52b089ae272098999"
        };
        // -----------------------------------------------------------

        // Firebase Ba≈ülatma
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Global Deƒüi≈ükenler (Mod√ºl dƒ±≈üƒ±na aktarmak i√ßin window'a atƒ±yoruz)
        window.db = db;
        window.storage = storage;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.where = where;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.orderBy = orderBy;
        window.serverTimestamp = serverTimestamp;
        
        // Storage fonksiyonlarƒ±
        window.ref = ref;
        window.uploadString = uploadString;
        window.getDownloadURL = getDownloadURL;
        window.deleteObject = deleteObject;

        // Sayfa y√ºklendiƒüinde u√ßaklarƒ± getir
        loadAirplanes();
    </script>

    <script>
        // --- DEƒûƒ∞≈ûKENLER ---
        let selectedImageBase64 = null;
        let currentEditingId = null;
        let unsubscribeDefects = null; // Listener'ƒ± kapatmak i√ßin
        let currentDefectsData = []; // Excel export ve arama i√ßin
        const suggestions = [
            "LAVATORY DOORS INNER MIRRORS ARE DAMAGED",
            "LAVATORY WASTE DOOR HINGE SCREWS ARE MISSING",
            "LAVATORY WASTE DOORS ARE NOT ADJUSTED",
            "LAVATORY DOOR GRILLS ARE DIRTY",
            "LAVATORY INNER DOOR LATCHES ARE NOT WORKING PROPERLY",
            "LAVATORY FLOOR PANS ARE DAMAGED",
            "LAVATORY CABINET SERVICE PANEL HINGES ARE DAMAGED",
            "LAVATORY CEILING LENSES ARE DISLOCATED",
            "LAVATORY PAPER HOLDER ROLLERS ARE DAMAGED",
            "LAVATORY INNER AISLE SIDE WALL LOWER SURFACES ARE CORRODED",
            "LAVATORY DOORS ARE NOT ADJUSTED",
            "LAVATORY PLACARDS ARE MISSING"
        ];

        // --- U√áAK Y√ñNETƒ∞Mƒ∞ (KATEGORƒ∞ YERƒ∞NE) ---
        
        async function loadAirplanes() {
    if (!window.db) { setTimeout(loadAirplanes, 500); return; }

    const airplaneSelect = document.getElementById("airplane-select");
    // √ñnce temizle, sonra varsayƒ±lan ve "T√úM U√áAKLAR" se√ßeneƒüini ekle
    airplaneSelect.innerHTML = `
        <option value="" disabled selected>U√ßak Se√ßiniz</option>
        <option value="ALL">--- T√úM U√áAKLAR ---</option>
    `;
    
    try {
        const q = window.query(window.collection(window.db, "airplanes"), window.orderBy("name"));
        const querySnapshot = await window.getDocs(q);
        
        querySnapshot.forEach((doc) => {
            const opt = document.createElement("option");
            opt.value = doc.data().name;
            opt.text = doc.data().name;
            opt.dataset.id = doc.id; 
            airplaneSelect.appendChild(opt);
        });
        
        const lastPlane = localStorage.getItem("lastSelectedPlane");
        if(lastPlane) {
            airplaneSelect.value = lastPlane;
            filterByAirplane();
        }
    } catch (error) {
        console.error("U√ßaklar y√ºklenirken hata:", error);
    }
}

        async function addNewAirplane() {
            const planeName = prompt("Yeni eklenecek U√áAK ismini giriniz (√ñrn: TC-LGA):");
            if (!planeName) return;
            const upperName = planeName.toUpperCase().trim();

            if (!window.db) { alert("Veritabanƒ± hazƒ±r deƒüil"); return; }

            try {
                // M√ºkerrer kontrol√º
                const q = window.query(window.collection(window.db, "airplanes"), window.where("name", "==", upperName));
                const snap = await window.getDocs(q);
                if (!snap.empty) {
                    alert("Bu u√ßak zaten listede var.");
                    return;
                }

                await window.addDoc(window.collection(window.db, "airplanes"), {
                    name: upperName,
                    createdAt: window.serverTimestamp()
                });
                
                // Listeyi yenile
                await loadAirplanes();
                // Yeni eklenen u√ßaƒüƒ± se√ß
                document.getElementById("airplane-select").value = upperName;
                filterByAirplane();

            } catch (e) {
                console.error("Hata:", e);
                alert("U√ßak eklenemedi: " + e.message);
            }
        }

        async function deleteSelectedAirplane() {
    const select = document.getElementById("airplane-select");
    const selectedPlane = select.value;
    
    // 1. Kontrol: Se√ßim yapƒ±lmamƒ±≈üsa veya "ALL" se√ßiliyse i≈ülemi durdur
    if (!selectedPlane || selectedPlane === "ALL") {
        alert("L√ºtfen silmek istediƒüiniz u√ßaƒüƒ± tekil olarak se√ßin.");
        return;
    }

    // Se√ßili u√ßaƒüƒ±n Firestore ID'sine eri≈üim
    const selectedOption = select.options[select.selectedIndex];
    const planeDocId = selectedOption.dataset.id;

    const confirmMessage = `${selectedPlane} u√ßaƒüƒ±nƒ±, bu u√ßaƒüa ait T√úM DEFECT KAYITLARINI ve RESƒ∞MLERƒ∞ kalƒ±cƒ± olarak silmek istediƒüinize emin misiniz?\n\nBU ƒ∞≈ûLEM GERƒ∞ ALINAMAZ!`;
    
    if (!confirm(confirmMessage)) return;

    try {
        // Aray√ºzde i≈ülem ba≈üladƒ±ƒüƒ±nƒ± g√∂ster
        document.getElementById("defect-list").innerHTML = '<li style="text-align:center;">Baƒülƒ± kayƒ±tlar temizleniyor, l√ºtfen bekleyin...</li>';

        // 2. A≈ûAMA: U√ßaƒüa ait t√ºm defectleri bul
        const q = window.query(
            window.collection(window.db, "defects"), 
            window.where("airplane", "==", selectedPlane)
        );
        const querySnapshot = await window.getDocs(q);

        // 3. A≈ûAMA: Her bir defect kaydƒ±nƒ± ve resmini tek tek sil
        const deletePromises = [];
        
        querySnapshot.forEach((defectDoc) => {
            const data = defectDoc.data();
            const defectId = defectDoc.id;

            // Varsa resmi Storage'dan sil
            if (data.imageUrl && data.imageUrl.startsWith("https://firebasestorage")) {
                const imageRef = window.ref(window.storage, data.imageUrl);
                deletePromises.push(window.deleteObject(imageRef).catch(e => console.warn("Resim silinemedi:", e)));
            }

            // Defect dok√ºmanƒ±nƒ± Firestore'dan sil
            deletePromises.push(window.deleteDoc(window.doc(window.db, "defects", defectId)));
        });

        // T√ºm defect ve resim silme i≈ülemlerinin bitmesini bekle
        await Promise.all(deletePromises);

        // 4. A≈ûAMA: U√ßaƒüƒ±n kendisini "airplanes" koleksiyonundan sil
        await window.deleteDoc(window.doc(window.db, "airplanes", planeDocId));

        alert(`${selectedPlane} u√ßaƒüƒ± ve ilgili t√ºm veriler ba≈üarƒ±yla temizlendi.`);

        // 5. A≈ûAMA: Aray√ºz√º temizle ve listeyi yenile
        select.value = "";
        localStorage.removeItem("lastSelectedPlane");
        await loadAirplanes(); 
        document.getElementById("defect-list").innerHTML = ""; 

    } catch (e) {
        console.error("Silme i≈ülemi sƒ±rasƒ±nda hata:", e);
        alert("ƒ∞≈ülem sƒ±rasƒ±nda bir hata olu≈ütu: " + e.message);
    }
}

        function filterByAirplane() {
    const plane = document.getElementById("airplane-select").value;
    if (!plane) return;

    localStorage.setItem("lastSelectedPlane", plane);
    
    let q;
    if (plane === "ALL") {
        document.getElementById("list-header").innerText = `T√ºm Kayƒ±tlƒ± Defectler`;
        // Filtreleme yapmadan t√ºm koleksiyonu getir
        q = window.query(window.collection(window.db, "defects"));
    } else {
        document.getElementById("list-header").innerText = `${plane} ƒ∞√ßin Kayƒ±tlar`;
        // Sadece se√ßili u√ßaƒüa g√∂re filtrele
        q = window.query(
            window.collection(window.db, "defects"), 
            window.where("airplane", "==", plane)
        );
    }

    if (unsubscribeDefects) {
        unsubscribeDefects();
    }

    const listEl = document.getElementById("defect-list");
    listEl.innerHTML = '<li style="text-align:center;">Y√ºkleniyor...</li>';

    unsubscribeDefects = window.onSnapshot(q, (snapshot) => {
        listEl.innerHTML = "";
        currentDefectsData = []; 

        if (snapshot.empty) {
            listEl.innerHTML = '<li style="text-align:center;">Kayƒ±t bulunamadƒ±.</li>';
            return;
        }

        let tempDocs = [];
        snapshot.forEach((doc) => {
            let d = doc.data();
            d.id = doc.id;
            tempDocs.push(d);
        });

        // Tarihe g√∂re sƒ±ralama (En yeni en √ºstte)
        tempDocs.sort((a, b) => {
            if(!a.createdAt || !b.createdAt) return 0;
            return b.createdAt.seconds - a.createdAt.seconds;
        });

        tempDocs.forEach((data) => {
            currentDefectsData.push(data);
            renderDefectItem(data);
        });

    }, (error) => {
        console.error("Veri √ßekme hatasƒ±:", error);
        listEl.innerHTML = "Veriler alƒ±namadƒ±.";
    });
}

        function renderDefectItem(data) {
            const listEl = document.getElementById("defect-list");
            const li = document.createElement('li');
            
            let imageHtml = '';
            if (data.imageUrl) {
                imageHtml = `<img src="${data.imageUrl}" onclick="window.open('${data.imageUrl}', '_blank')">`;
            } else if (data.image) {
                // Eski base64 desteƒüi (migrate edilmemi≈ü veriler i√ßin)
                imageHtml = `<img src="${data.image}" onclick="window.open('${data.image}', '_blank')">`;
            }

            li.innerHTML = `
                ${imageHtml}
                <div class="defect-details">
                    <div><span class="label">U√áAK:</span> ${data.airplane}</div>
                    <div><span class="label">DEFECT:</span> ${data.defect}</div>
                    <div><span class="label">LOCATION:</span> ${data.location}</div>
                    ${data.note ? `<div><span class="label">NOTE:</span> ${data.note}</div>` : ''}
                    ${data.partNumber ? `<div><span class="label">P/N:</span> ${data.partNumber}</div>` : ''}
                    ${data.manHours ? `<div><span class="label">M/H:</span> ${data.manHours}</div>` : ''}
                </div>
                <div class="buttons">
                    <button class="airplane-btn" style="background-color:#ffc107; color:black" onclick="prepareEdit('${data.id}')">‚úèÔ∏è</button>
                    <button class="airplane-btn delete" onclick="deleteDefect('${data.id}', '${data.imageUrl}')">üóëÔ∏è</button>
                </div>
            `;
            listEl.appendChild(li);
        }

        // --- CRUD ƒ∞≈ûLEMLERƒ∞ (FIREBASE) ---

        async function saveDefectToFirebase() {
            const airplane = document.getElementById('airplane-select').value;
            const defect = document.getElementById('defect').value;
            const location = document.getElementById('location').value;
            const note = document.getElementById('note').value;
            const partNumber = document.getElementById('partNumber').value;
            const manHours = document.getElementById('manHours').value;

            if (!airplane) { alert("L√ºtfen bir U√áAK se√ßiniz."); return; }
            if (!defect || !location) { alert("Defect ve Location alanlarƒ± zorunludur."); return; }

            const btn = document.querySelector('.main-save-btn');
            const loader = document.getElementById('save-loader');
            const btnText = document.getElementById('save-text');
            
            btn.disabled = true;
            btnText.style.display = 'none';
            loader.style.display = 'block';

            try {
                let imageUrl = "";

                // Resim y√ºkleme i≈ülemi
                if (selectedImageBase64) {
                    const storageRef = window.ref(window.storage, `defect_images/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.jpg`);
                    await window.uploadString(storageRef, selectedImageBase64, 'data_url');
                    imageUrl = await window.getDownloadURL(storageRef);
                } else if (currentEditingId && currentDefectsData.find(d => d.id === currentEditingId)?.imageUrl) {
                    // D√ºzenleme yapƒ±lƒ±yor ve yeni resim se√ßilmediyse eskisini koru
                    imageUrl = currentDefectsData.find(d => d.id === currentEditingId).imageUrl;
                }

                const defectObj = {
                    airplane,
                    defect,
                    location,
                    note,
                    partNumber,
                    manHours,
                    imageUrl: imageUrl,
                    createdAt: window.serverTimestamp() // Sƒ±ralama i√ßin
                };

                if (currentEditingId) {
                    // G√ºncelleme
                    const docRef = window.doc(window.db, "defects", currentEditingId);
                    // createdAt g√ºncelleme sƒ±rasƒ±nda deƒüi≈ümesin
                    delete defectObj.createdAt; 
                    await window.updateDoc(docRef, defectObj);
                    alert("Kayƒ±t g√ºncellendi!");
                    currentEditingId = null;
                } else {
                    // Yeni Kayƒ±t
                    await window.addDoc(window.collection(window.db, "defects"), defectObj);
                    // alert("Kayƒ±t ba≈üarƒ±lƒ±!"); // Snapshot listener otomatik g√ºncelleyeceƒüi i√ßin alert opsiyonel
                }

                clearForm();

            } catch (error) {
                console.error("Kaydetme hatasƒ±:", error);
                alert("Hata olu≈ütu: " + error.message);
            } finally {
                btn.disabled = false;
                btnText.style.display = 'inline';
                loader.style.display = 'none';
                btnText.innerText = "Kaydet";
            }
        }

        async function deleteDefect(id, imageUrl) {
            if (!confirm("Bu kaydƒ± ve RESMƒ∞ kalƒ±cƒ± olarak silmek istediƒüinize emin misiniz?")) return;

            // Y√ºkleme animasyonu ekleyelim (Butonun ikonunu deƒüi≈ütirerek)
            const listEl = document.getElementById("defect-list");
            // Kullanƒ±cƒ±ya i≈ülemin ba≈üladƒ±ƒüƒ±nƒ± hissettirmek i√ßin basit bir y√∂ntem
            
            try {
                // 1. √ñnce Veritabanƒ± Kaydƒ±nƒ± Sil
                await window.deleteDoc(window.doc(window.db, "defects", id));

                // 2. Eƒüer Resim Varsa ve Firebase Linki ƒ∞se Storage'dan da Sil
                if (imageUrl && imageUrl.startsWith("https://firebasestorage")) {
                    try {
                        // URL'den referans olu≈üturup silme i≈ülemi
                        const imageRef = window.ref(window.storage, imageUrl);
                        await window.deleteObject(imageRef);
                        console.log("Resim ba≈üarƒ±yla silindi.");
                    } catch (imgError) {
                        console.warn("Resim silinemedi (Zaten silinmi≈ü olabilir):", imgError);
                        // Resim silinmese bile kayƒ±t silindiƒüi i√ßin akƒ±≈üƒ± bozmuyoruz.
                    }
                }

                alert("Kayƒ±t ve resim ba≈üarƒ±yla silindi.");

            } catch (error) {
                console.error("Silme hatasƒ±:", error);
                alert("Silinirken bir hata olu≈ütu: " + error.message);
            }
        }

        function prepareEdit(id) {
            const data = currentDefectsData.find(d => d.id === id);
            if (!data) return;

            document.getElementById('airplane-select').value = data.airplane; // U√ßak deƒüi≈üirse uyarabilir
            document.getElementById('defect').value = data.defect;
            document.getElementById('location').value = data.location;
            document.getElementById('note').value = data.note || "";
            document.getElementById('partNumber').value = data.partNumber || "";
            document.getElementById('manHours').value = data.manHours || "";
            
            currentEditingId = id;
            document.querySelector('.main-save-btn span').innerText = "G√ºncelle";
            
            if (data.imageUrl) {
                document.getElementById('image-preview-container').style.display = 'block';
                document.getElementById('preview-img').src = data.imageUrl;
            }
            
            document.querySelector('.container').scrollIntoView({ behavior: 'smooth' });
        }

        // --- YARDIMCI FONKSƒ∞YONLAR ---

        function handleUpperCase(input) {
            input.value = input.value.toUpperCase();
        }

        function addShortcut(text) {
            let defectInput = document.getElementById("defect");
            if (defectInput.value.trim() !== "") {
                defectInput.value += " IS " + text;
            } else {
                defectInput.value = text;
            }
            document.getElementById('location').focus();
        }

        function clearForm() {
            document.getElementById('defect').value = '';
            document.getElementById('location').value = '';
            document.getElementById('note').value = '';
            document.getElementById('partNumber').value = '';
            document.getElementById('manHours').value = '';
            document.getElementById('camera-upload').value = '';
            document.getElementById('gallery-upload').value = '';
            clearImageSelection();
            document.getElementById('save-text').innerText = "Kaydet";
            currentEditingId = null;
        }

        function clearImageSelection() {
            selectedImageBase64 = null;
            document.getElementById('image-preview-container').style.display = 'none';
            document.getElementById('preview-img').src = '';
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const scale = parseFloat(document.getElementById("image-scale").value) || 1;
                resizeImage(e.target.result, scale).then(resizedImage => {
                    selectedImageBase64 = resizedImage;
                    document.getElementById('image-preview-container').style.display = 'block';
                    document.getElementById('preview-img').src = resizedImage;
                });
            };
            reader.readAsDataURL(file);
        }

        function resizeImage(imageSrc, scale) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = imageSrc;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const newWidth = img.width * scale;
                    const newHeight = img.height * scale;
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    resolve(canvas.toDataURL('image/jpeg', 0.8)); // JPEG formatƒ±nda sƒ±kƒ±≈ütƒ±r
                };
            });
        }

        function searchLocalList() {
            const term = document.getElementById('search').value.toUpperCase();
            const listEl = document.getElementById('defect-list');
            listEl.innerHTML = "";
            
            const filtered = currentDefectsData.filter(d => 
                (d.defect && d.defect.includes(term)) ||
                (d.location && d.location.includes(term)) ||
                (d.note && d.note.includes(term))
            );

            filtered.forEach(data => renderDefectItem(data));
        }

function showSuggestions(val) {
    const list = document.getElementById("suggestion-list");

    // ENTER sonrasƒ± manuel kapatƒ±ldƒ±ysa tekrar a√ßma
    if (list.dataset.locked === "true") return;

    list.innerHTML = "";
    list.style.display = "none";

    if (!val.trim()) return;

    const matches = suggestions.filter(s => s.includes(val));
    if (matches.length > 0) {
        list.style.display = "block";
        matches.forEach(s => {
            const div = document.createElement("div");
            div.innerText = s;
            div.onclick = () => {
                document.getElementById("defect").value = s;
                list.style.display = "none";
                list.dataset.locked = "true";

                document.getElementById("location").focus();

                // Kilidi kƒ±sa s√ºre sonra kaldƒ±r
                setTimeout(() => {
                    list.dataset.locked = "false";
                }, 200);
            };
            list.appendChild(div);
        });
    }
}



// Mobil ve Masa√ºst√º uyumlu Enter takibi (G√úNCELLENDƒ∞)
document.getElementById("defect").addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
        e.preventDefault();

        const list = document.getElementById("suggestion-list");

        // Listeyi kilitle ve kapat
        list.style.display = "none";
        list.dataset.locked = "true";

        this.blur();

        setTimeout(() => {
            document.getElementById("location").focus();
            list.dataset.locked = "false";
        }, 150);
    }
});




        // Ekranda herhangi bir yere dokunulduƒüunda √∂neri listesini kapatƒ±r
document.addEventListener('click', function(event) {
    const list = document.getElementById("suggestion-list");
    const defectInput = document.getElementById("defect");

    // Eƒüer tƒ±klanan yer defect kutusu deƒüilse VE √∂neri listesinin kendisi deƒüilse
    if (!defectInput.contains(event.target) && !list.contains(event.target)) {
        list.style.display = "none";
    }
});

async function resizeImageFromUrl(imageUrl, scale) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "Anonymous"; // CORS i√ßin kritik
        img.src = imageUrl;
        
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Orijinal boyutlarƒ± alƒ±yoruz
            let targetWidth = img.width * scale;
            let targetHeight = img.height * scale;
            
            canvas.width = targetWidth;
            canvas.height = targetHeight;
            
            ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
            
            // Her zaman Base64 d√∂nd√ºr√ºr (Kalite 1 olsa bile)
            const base64 = canvas.toDataURL('image/jpeg', 0.8);
            resolve(base64);
        };
        
        img.onerror = (e) => {
            console.error("Resim y√ºkleme hatasƒ± (CORS veya Link bozuk):", imageUrl);
            reject(e);
        };
    });
}



// --- EXCEL EXPORT (Firebase Data Kullanarak) ---
async function exportToExcel() {
    if (currentDefectsData.length === 0) {
        alert("Listede aktarƒ±lacak veri yok.");
        return;
    }

    const exportBtn = document.querySelector('.export-button');
    const exportScale = parseFloat(document.getElementById('export-scale').value);
    const originalText = exportBtn.innerText;
    
    exportBtn.disabled = true;
    exportBtn.innerText = "Resimler Hazƒ±rlanƒ±yor...";

    try {
        const workbook = new ExcelJS.Workbook();
        const sheet = workbook.addWorksheet("Defect Raporu");
        
        sheet.columns = [
            { header: "U√áAK", key: "airplane", width: 15 },
            { header: "DEFECT", key: "defect", width: 35 },
            { header: "LOCATION", key: "location", width: 20 },
            { header: "NOTE", key: "note", width: 25 },
            { header: "P/N", key: "partNumber", width: 15 },
            { header: "M/H", key: "manHours", width: 10 },
            { header: "RESƒ∞M", key: "image", width: 30 }
        ];

        // Ba≈ülƒ±k stilini kalƒ±n yap
        sheet.getRow(1).font = { bold: true };

        for (let i = 0; i < currentDefectsData.length; i++) {
            const d = currentDefectsData[i];
            const rowNumber = i + 2;
            
            // Satƒ±rƒ± ekle
            const row = sheet.addRow({
                airplane: d.airplane || "",
                defect: d.defect || "",
                location: d.location || "",
                note: d.note || "",
                partNumber: d.partNumber || "",
                manHours: d.manHours || ""
            });
            
            row.height = 95; // Resim i√ßin satƒ±r y√ºksekliƒüi

            const imgUrl = d.imageUrl || d.image;

            if (imgUrl) {
                try {
                    // Resim URL'sini se√ßilen kaliteye g√∂re Base64'e √ßevir
                    const base64Data = await resizeImageFromUrl(imgUrl, exportScale);
                    
                    // ExcelJS'e resmi ekle (Sadece data kƒ±smƒ±nƒ± alƒ±yoruz)
                    const imageId = workbook.addImage({
                        base64: base64Data,
                        extension: 'jpeg',
                    });

                    sheet.addImage(imageId, {
                        tl: { col: 6, row: rowNumber - 1 },
                        ext: { width: 180, height: 120 },
                        editAs: 'oneCell'
                    });
                } catch (err) {
                    console.warn("Satƒ±r " + rowNumber + " i√ßin resim i≈ülenemedi:", err);
                    row.getCell(7).value = "Resim Y√ºklenemedi";
                }
            }
        }

        // Dosyayƒ± Olu≈ütur ve ƒ∞ndir
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const fileName = `Defect_Raporu_${new Date().toISOString().split('T')[0]}.xlsx`;
        
        a.href = url;
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(url);
        
    } catch (error) {
        console.error("Excel Hatasƒ±:", error);
        alert("Excel olu≈üturulurken bir hata olu≈ütu: " + error.message);
    } finally {
        exportBtn.disabled = false;
        exportBtn.innerText = originalText;
    }
}

        

        // --- SIDEBAR & THEME ---
        function toggleSidebar() {
            document.getElementById("sidebar").classList.toggle("open");
            document.getElementById("main-container").classList.toggle("sidebar-open");
        }
        function changeTheme() {
            if (document.getElementById("theme-select").value === "dark") {
                document.body.classList.add("dark-theme");
            } else {
                document.body.classList.remove("dark-theme");
            }
        }


// --- √ñNERƒ∞ Lƒ∞STESƒ∞ VE TEXTBOX GE√áƒ∞≈û Y√ñNETƒ∞Mƒ∞ ---
const defectInput = document.getElementById("defect");
const suggestionList = document.getElementById("suggestion-list");
const allInputs = ["defect", "location", "note", "partNumber", "manHours"];

// 1. Kutudan √ßƒ±kƒ±nca listeyi gizle (Blur)
defectInput.addEventListener("blur", function() {
    // Kƒ±sa bir gecikme ekliyoruz ki listedeki bir maddeye tƒ±klandƒ±ƒüƒ±nda 
    // liste hemen kapanƒ±p tƒ±klamayƒ± iptal etmesin.
    setTimeout(() => {
        suggestionList.style.display = "none";
    }, 200);
});

// 2. Kutuya odaklanƒ±nca (eƒüer yazƒ± varsa) listeyi tekrar g√∂ster (Focus)
defectInput.addEventListener("focus", function() {
    if (this.value.trim() !== "") {
        showSuggestions(this.value);
    }
});

// 3. T√ºm textboxlar i√ßin Enter ile bir sonrakine ge√ßi≈ü
allInputs.forEach((id, index) => {
    const inputEl = document.getElementById(id);
    if (!inputEl) return;

    inputEl.addEventListener("keydown", function(e) {
        if (e.key === "Enter" || e.keyCode === 13) {
            e.preventDefault();

            // Eƒüer defect kutusundaysak listeyi hemen kapat
            if (id === "defect") {
                suggestionList.style.display = "none";
            }

            const nextId = allInputs[index + 1];
            if (nextId) {
                const nextEl = document.getElementById(nextId);
                this.blur(); // Mevcut odaƒüƒ± bƒ±rak (mobil klavye y√∂netimi i√ßin)
                setTimeout(() => nextEl.focus(), 100);
            } else {
                this.blur(); // Son kutu ise klavyeyi kapat
            }
        }
    });
});



        
    </script>
</body>
</html>
